---
layout: post
title: ssh-agent & capistrano
---

### 缘起

敝公司的线上环境与业界大拿相仿，躲在防火墙后面，需要通过跳板机登录。在本文描述的问题出现之前，
我们的 capistrano 部署脚本一直采用的方式是，配置 `:gateway`，让 capistrano 处理中转。

[capistrano 的原理](http://weblog.jamisbuck.org/2006/9/26/inside-capistrano-the-gateway-implementation)
是利用跳板机开一个 SSH 隧道，然后本地连接这个隧道，执行操作，等同与以下命令：

{% highlight bash %}
# Term 1
ssh -N 9999:prod.server:22 -L jake@login1

# Term 2
ssh jake@127.0.0.1:9999
{% endhighlight %}

元旦之后，这种方式宣告失败，`ssh jake@127.0.0.1:9999` 连不上，终端 1 里开起来的隧道返回：

    Channel 2: open failed: administratively prohibited: open failed

当时很苦恼，还去
[capisrano 群组求助](https://groups.google.com/forum/#!topic/capistrano/3p09d46erFQ)，
幸亏阅读相关文档之后，终于搞定。

### ProxyCommand

解决的办法其实简单，就是 ProxyCommand。在本机的 `~/.ssh/config` 中，如下配置：

    Host prod.server
      User jake
      ProxyCommand ssh -A login1 nc %h %p

然后就可以直接 `ssh prod.server` 了，也就是说，可以去掉 `config/deploy.rb` 中的
`:gateway`，直接连接生产环境。

### ssh-agent

但这有个不足处，需要输两次密码，解决办法也很简单，就是 `ssh-agent`。我们首先要生成一个秘钥，

    ssh-keygen -N myprecious -f ~/.ssh/corp

以上命令，生成一个名叫 corp，并有 myprecious 作为密码保护的秘钥。也可以使用无密码保护的秘钥，
但假如秘钥文件丢失，风险很大，而使用 `ssh-agent`，在使用体验上等同于无密码，所以，
推荐使用密码保护。

将 corp.pub 的内容分别加入 login1 与 prod.server 的相应用户的
`~/.ssh/authorized_keys` 中，并配置本机与 login1 机器上的转发，即修改两台机器的
`~/.ssh/config`：

本机：

    Host login1
      ForwardAgent true

login1 机器：

    Host prod.server
      ForwardAgent true

配置完之后，把这个秘钥交给 `ssh-agent`：

    ssh-add ~/.ssh/corp.pub

可能会报 Could not open a connection to your authentication agent.
这个错误的意思是，ssh-agent 还没有跑起来，执行一下：

    ssh-agent $SHELL

即可。秘钥交付完毕之后，我们测试一把：

{% highlight bash %}
# 通过 login1 连接 prod.server
# -t 参数表示，请一定分配 Terminal
ssh -t login1 ssh prod.server

# 看看是否连到线上
hostname    # ==> prod.server
{% endhighlight %}

如此，配合 ProxyCommand，就可以免密码，直接 `ssh prod.server` 啦。

### 参考资料

 - [Introducing SSH](http://kimmo.suominen.com/docs/ssh/)
 - [An Illustrated Guide to SSH Agent Forwarding](http://unixwiz.net/techtips/ssh-agent-forwarding.html)
 - [Transparent Multi-hop SSH](http://sshmenu.sourceforge.net/articles/transparent-mulithop.html)
 - [The Administratively Prohibited Error](http://unix.stackexchange.com/questions/14160/ssh-tunneling-error-channel-1-open-failed-administratively-prohibited-open)
 - [ProxyCommand](http://superuser.com/questions/107679/forward-ssh-traffic-through-a-middle-machine)